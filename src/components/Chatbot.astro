<!-- Chatbot Lead Qualification Widget -->
<div id="chatbot-widget">
  <!-- Toggle Button -->
  <button
    id="chatbot-toggle"
    aria-label="Open chat assistant"
    class="fixed bottom-6 right-6 z-50 w-14 h-14 bg-amber-500 hover:bg-amber-600 text-vp-bg rounded-full shadow-lg shadow-amber-500/25 flex items-center justify-center transition-all duration-300 hover:scale-110"
  >
    <svg id="chatbot-icon-open" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
    </svg>
    <svg id="chatbot-icon-close" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
    </svg>
  </button>

  <!-- Chat Panel -->
  <div
    id="chatbot-panel"
    class="fixed bottom-24 right-6 z-50 w-[360px] max-h-[520px] bg-vp-surface border border-zinc-700 rounded-xl shadow-2xl shadow-black/50 flex flex-col overflow-hidden transition-all duration-300 origin-bottom-right scale-0 opacity-0"
  >
    <!-- Header -->
    <div class="bg-vp-bg border-b border-zinc-700 px-5 py-4 flex items-center gap-3">
      <div class="w-8 h-8 bg-amber-500 rounded-full flex items-center justify-center flex-shrink-0">
        <svg class="w-4 h-4 text-vp-bg" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
        </svg>
      </div>
      <div>
        <p class="text-white font-semibold text-sm">Vantage Point</p>
        <p class="text-zinc-500 text-xs">Project Assistant</p>
      </div>
    </div>

    <!-- Messages Area -->
    <div id="chatbot-messages" class="flex-1 overflow-y-auto px-5 py-4 space-y-4 min-h-[280px] max-h-[340px]">
    </div>

    <!-- Input Area (hidden until needed) -->
    <div id="chatbot-input-area" class="border-t border-zinc-700 px-4 py-3 hidden">
      <div class="flex gap-2">
        <input
          id="chatbot-input"
          type="text"
          placeholder="Type your answer..."
          class="flex-1 px-3 py-2 bg-vp-bg border border-zinc-700 rounded-lg text-white text-sm placeholder-zinc-500 focus:outline-none focus:border-amber-500 transition-colors"
        />
        <button
          id="chatbot-send"
          class="px-3 py-2 bg-amber-500 hover:bg-amber-600 text-vp-bg rounded-lg transition-colors"
          aria-label="Send"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  #chatbot-panel.open {
    transform: scale(1);
    opacity: 1;
  }

  .chat-bubble {
    max-width: 85%;
    padding: 0.625rem 0.875rem;
    border-radius: 0.75rem;
    font-size: 0.875rem;
    line-height: 1.5;
    animation: chat-fade-in 0.3s ease-out;
  }

  .chat-bubble.bot {
    background: #27272a;
    color: #fafafa;
    border-bottom-left-radius: 0.25rem;
    align-self: flex-start;
  }

  .chat-bubble.user {
    background: #f59e0b;
    color: #09090b;
    border-bottom-right-radius: 0.25rem;
    align-self: flex-end;
    margin-left: auto;
  }

  .chat-options {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
    margin-top: 0.5rem;
    animation: chat-fade-in 0.3s ease-out;
  }

  .chat-option-btn {
    padding: 0.5rem 0.75rem;
    background: transparent;
    border: 1px solid #3f3f46;
    border-radius: 0.5rem;
    color: #fafafa;
    font-size: 0.8125rem;
    text-align: left;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .chat-option-btn:hover {
    border-color: #f59e0b;
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
  }

  .typing-indicator {
    display: flex;
    gap: 4px;
    padding: 0.625rem 0.875rem;
    align-self: flex-start;
  }

  .typing-indicator span {
    width: 6px;
    height: 6px;
    background: #71717a;
    border-radius: 50%;
    animation: typing-bounce 1.4s ease-in-out infinite;
  }

  .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
  .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes typing-bounce {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-4px); }
  }

  @keyframes chat-fade-in {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<script>
  const STEPS = [
    {
      id: 'welcome',
      message: 'Hey! ðŸ‘‹ I\'m the Vantage Point project assistant. I can help you figure out what you need and get a quote fast. Ready to get started?',
      options: [
        { label: 'Yes, let\'s go!', value: 'start' },
        { label: 'Just browsing', value: 'browse' },
      ],
    },
    {
      id: 'projectType',
      message: 'What kind of project are you working on?',
      options: [
        { label: 'Construction / Site Monitoring', value: 'construction-monitoring' },
        { label: 'Solar Assessment', value: 'solar-assessment' },
        { label: 'Roof Measurement', value: 'roof-measurement' },
        { label: 'Stockpile / Mining', value: 'stockpile' },
        { label: 'Agriculture / NDVI', value: 'agricultural' },
        { label: 'Something else', value: 'other' },
      ],
    },
    {
      id: 'siteSize',
      message: 'How big is the project site? (Approximate acres or description is fine.)',
      input: true,
      placeholder: 'e.g. 10 acres, city block, rooftop',
    },
    {
      id: 'timeline',
      message: 'When do you need the data captured?',
      options: [
        { label: 'ASAP / This week', value: 'asap' },
        { label: 'Within 2 weeks', value: '2-weeks' },
        { label: 'Within a month', value: '1-month' },
        { label: 'Flexible / Ongoing', value: 'flexible' },
      ],
    },
    {
      id: 'deliverables',
      message: 'What deliverables do you need? (Select all that apply, or describe below.)',
      options: [
        { label: 'Orthomosaic Maps', value: 'orthomosaic' },
        { label: '3D Point Cloud', value: 'pointcloud' },
        { label: 'Progress Photos/Video', value: 'progress' },
        { label: 'Volumetric Report', value: 'volumetrics' },
        { label: 'Not sure yet', value: 'unsure' },
      ],
    },
    {
      id: 'name',
      message: 'Great info! What\'s your name?',
      input: true,
      placeholder: 'Your name',
    },
    {
      id: 'email',
      message: 'And your email so we can send you a quote?',
      input: true,
      placeholder: 'you@company.com',
      validate: 'email',
    },
    {
      id: 'phone',
      message: 'Phone number? (Optional, but helps for quick follow-up.)',
      input: true,
      placeholder: '(555) 000-0000',
      optional: true,
    },
  ];

  const BROWSE_MESSAGE = 'No problem! Feel free to look around. When you\'re ready for a quote, just click the chat icon or visit our <a href="/contact" class="text-amber-400 hover:text-amber-300 underline">contact page</a>.';
  const FINAL_MESSAGE = 'You\'re all set! We\'ll review your project details and get back to you within 24 hours with a custom quote. Thanks for choosing Vantage Point!';

  let currentStep = 0;
  let leadData = {};

  const panel = document.getElementById('chatbot-panel');
  const toggle = document.getElementById('chatbot-toggle');
  const iconOpen = document.getElementById('chatbot-icon-open');
  const iconClose = document.getElementById('chatbot-icon-close');
  const messagesEl = document.getElementById('chatbot-messages');
  const inputArea = document.getElementById('chatbot-input-area');
  const inputEl = document.getElementById('chatbot-input');
  const sendBtn = document.getElementById('chatbot-send');

  let isOpen = false;
  let started = false;

  toggle.addEventListener('click', () => {
    isOpen = !isOpen;
    panel.classList.toggle('open', isOpen);
    iconOpen.classList.toggle('hidden', isOpen);
    iconClose.classList.toggle('hidden', !isOpen);

    if (isOpen && !started) {
      started = true;
      showStep(0);
    }
  });

  function scrollToBottom() {
    setTimeout(() => {
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }, 50);
  }

  function addBotMessage(html) {
    const div = document.createElement('div');
    div.className = 'chat-bubble bot';
    div.innerHTML = html;
    messagesEl.appendChild(div);
    scrollToBottom();
  }

  function addUserMessage(text) {
    const div = document.createElement('div');
    div.className = 'chat-bubble user';
    div.textContent = text;
    messagesEl.appendChild(div);
    scrollToBottom();
  }

  function addOptions(options) {
    const container = document.createElement('div');
    container.className = 'chat-options';
    options.forEach((opt) => {
      const btn = document.createElement('button');
      btn.className = 'chat-option-btn';
      btn.textContent = opt.label;
      btn.addEventListener('click', () => {
        container.remove();
        handleOptionSelect(opt);
      });
      container.appendChild(btn);
    });
    messagesEl.appendChild(container);
    scrollToBottom();
  }

  function showTyping() {
    const div = document.createElement('div');
    div.className = 'typing-indicator';
    div.id = 'typing';
    div.innerHTML = '<span></span><span></span><span></span>';
    messagesEl.appendChild(div);
    scrollToBottom();
  }

  function hideTyping() {
    const el = document.getElementById('typing');
    if (el) el.remove();
  }

  function showStep(index) {
    if (index >= STEPS.length) {
      submitLead();
      return;
    }

    const step = STEPS[index];
    showTyping();

    setTimeout(() => {
      hideTyping();
      addBotMessage(step.message);

      if (step.options) {
        addOptions(step.options);
        inputArea.classList.add('hidden');
      } else if (step.input) {
        inputArea.classList.remove('hidden');
        inputEl.placeholder = step.placeholder || 'Type here...';
        inputEl.value = '';
        inputEl.focus();
      }
    }, 600);
  }

  function handleOptionSelect(opt) {
    addUserMessage(opt.label);
    const step = STEPS[currentStep];

    if (step.id === 'welcome') {
      if (opt.value === 'browse') {
        showTyping();
        setTimeout(() => {
          hideTyping();
          addBotMessage(BROWSE_MESSAGE);
        }, 500);
        return;
      }
      currentStep++;
      showStep(currentStep);
      return;
    }

    leadData[step.id] = opt.value;
    currentStep++;
    showStep(currentStep);
  }

  function handleTextInput() {
    const value = inputEl.value.trim();
    if (!value) return;

    const step = STEPS[currentStep];

    if (step.validate === 'email') {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(value)) {
        addBotMessage('That doesn\'t look like a valid email. Could you try again?');
        inputEl.value = '';
        inputEl.focus();
        return;
      }
    }

    addUserMessage(value);
    leadData[step.id] = value;
    inputArea.classList.add('hidden');
    currentStep++;
    showStep(currentStep);
  }

  sendBtn.addEventListener('click', handleTextInput);
  inputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleTextInput();
    }
  });

  function submitLead() {
    showTyping();

    setTimeout(() => {
      hideTyping();
      addBotMessage(FINAL_MESSAGE);
      inputArea.classList.add('hidden');

      // Try HubSpot submission
      const form = document.getElementById('contactForm');
      let portalId, formGuid;
      if (form) {
        portalId = form.getAttribute('data-portal-id');
        formGuid = form.getAttribute('data-form-guid');
      }

      const nameParts = (leadData.name || '').split(' ');
      const firstName = nameParts[0] || '';
      const lastName = nameParts.slice(1).join(' ') || '';

      const details = [
        'Project Type: ' + (leadData.projectType || 'N/A'),
        'Site Size: ' + (leadData.siteSize || 'N/A'),
        'Timeline: ' + (leadData.timeline || 'N/A'),
        'Deliverables: ' + (leadData.deliverables || 'N/A'),
      ].join('\n');

      if (portalId && formGuid && portalId !== 'YOUR_PORTAL_ID') {
        const payload = {
          fields: [
            { name: 'firstname', value: firstName },
            { name: 'lastname', value: lastName },
            { name: 'email', value: leadData.email || '' },
            { name: 'phone', value: leadData.phone || '' },
            { name: 'message', value: details },
          ],
          context: {
            pageUri: window.location.href,
            pageName: 'Chatbot Lead',
          },
        };

        fetch(
          'https://api.hsforms.com/submissions/v3/integration/submit/' + portalId + '/' + formGuid,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          }
        ).catch((err) => console.warn('HubSpot chatbot submit failed:', err));
      } else {
        // Mailto fallback
        const subject = encodeURIComponent('Chatbot Lead: ' + (leadData.name || 'Unknown'));
        const body = encodeURIComponent(
          'Name: ' + (leadData.name || '') + '\n' +
          'Email: ' + (leadData.email || '') + '\n' +
          'Phone: ' + (leadData.phone || '') + '\n' +
          details
        );
        console.log('Lead data (mailto fallback):', leadData);
        console.log('Mailto link: mailto:contact@vantagepoint.com?subject=' + subject + '&body=' + body);
      }
    }, 800);
  }
</script>
